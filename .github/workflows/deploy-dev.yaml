# .github/workflows/deploy-dev.yaml
name: Polybot Deploy Dev

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

  workflow_dispatch:
    inputs:
      image:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug Secrets
        run: |
          echo "‚úÖ EC2_USERNAME=${{ secrets.EC2_USERNAME }}"
          echo "‚úÖ EC2_HOST=${{ secrets.EC2_HOST }}"

      - name: Check if EC2 secrets exist
        run: |
          if [ -z "${{ secrets.EC2_USERNAME }}" ]; then echo "‚ùå EC2_USERNAME is missing!"; else echo "‚úÖ EC2_USERNAME is set."; fi
          if [ -z "${{ secrets.EC2_HOST }}" ]; then echo "‚ùå EC2_HOST is missing!"; else echo "‚úÖ EC2_HOST is set."; fi
      - name: Echo secrets with redaction
        run: |
          echo "EC2_USERNAME: ***${{ secrets.EC2_USERNAME != '' }}"  # should print true
          echo "EC2_HOST: ***${{ secrets.EC2_HOST != '' }}"          # should print true

      - name: SSH and Deploy
        env:
          PRIVATE_KEY: "-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAzrr6EYl1XCw6s7y9/c8VDSvwY/e7GjSeC3GcZIFFR80Rb9d3
BqAZsTGqAoi2Rz+LFssFN/VPBEYiVKNbD7VE5X+etTpeNu3isBiA2dlV8nWhJMeN
NQLXNmaMWLbHmvitbiBSRgweZ2NXJXozxMUGnKUAkqi/p6jUoEBHIm9sSHKIgxQB
UOys2tVNshUH9Vq0Hfw0/5j9HEBVs4AFL5obZ3+t5IhsVAak391oUstkgKcowHss
KCXIN58SIiRGz8/iba1WB6Nq9AJOmgoafcJP39qN5wU2Sxw4WXZOQK4HP6BCq0nU
O+PrEKdYANgvVw1l79Yb7bLLkLzg4fz2jH2W7QIDAQABAoIBAC2BZu5ZTaYebkWG
NGQcI0wk8eNvcpYQIwHt3jkZY4CsmTv/N8oTj9Q7VGr+YPFKAXng8qMgsmYEciYj
VzYb9rB16R+HW5nHv3B31FUfzBV04yXPbzvOBkWJSTd19HYeaz6kire0jzS+3z32
qlKT9CKjB39A+f8T4MntnDruP+2qMvj5D4kOoDkPbLu2lWRvY4JtHpOoEMdku2i8
z8YoXnd66Hsh+tjplGVM7q91eYinW7Bv0nb5G+EHILbybvlTKnmMXcCl3PNjNGDF
/TBFJ09mv+Os1cMhORxLwBt0GW6jb5hfMazOMVuZl2QSa9V0ZKMlnFWsXmrSYqW2
ShWJFNkCgYEA9WfhWVVoxVfoEGEBygTcOOS5GFIrCw6dvY4HK6ncEC9R7fG5jJAv
CSvQ293k8e6FMEh0ol7jtSchRqfrGB16Ksznj/Ba5X/9J1fx5XqHIaPbG2Qtjk+B
ldphHa4npAVjJMdQKCiNvk8j2ARIa7lx0icH3+E2lomYZeGSzptb/Y8CgYEA16es
K4ME0nh2hjIsmUbCjhKr+LX4tZ7yJucJ5O7415UAAIG5XdmyiCrZ1ONGnKA+EuDO
Fz22k+55Ag/e26aewyZrJBcBlLpTc6LfkDiashNJvllN9ZFcTrWnQ/b/Zdc81CSF
MDXWMI6jNjStS3GYIgrZ0GFeSUW8N0g7mEaJ3cMCgYEA13EmPiYkP7Pn8JEpX/Ca
YXwzHy3ryd5AD0yj8OpDXxYb6DghfEyMbpG/33ZTay3KUdQaSP3jDINYzE3Yr6gZ
O3/9/ri1I+wUFDk6DQtfnOHcFpUBBYG5MxSv072z4WQ1YPF15nuLzLpvrlI8Pg5k
5WkMmbh/EvOjDjZVivqLbPMCgYAF/SYO30iW/7lq6KHMb+afQ217LrKFeLCI3Amu
TeSjOAQT/4ZCUPVgSrBZ9SXU265dn9iZVKFpYkoCAKbTusDV8o8vJWRp2PLQV0mW
G7xQDbESlDBSDYNevDS08nsNPPj3ezwnppcYKh3mN3hIjBMJfvulic6wgjtD3cGp
7OuPOQKBgQC3EB5VsWioXjiGa+rzFilyhbDRRDyfvgTuzSsB1bHdCOVRDUb+mRHn
NZmPY1NcxFQJEsULFy1q8AAfp2P8YhA0+6QCbO4rcn0JRplBmmWekAHfWX9Jqshl
17KzC9Aq3LY9kKQHrEE9BYy6YbsWzCbY+kK0avkrnjTiRKDACrdMeA==
-----END RSA PRIVATE KEY-----"
          EC2_USER: ubuntu
          EC2_HOST: 54.183.125.83
          IMAGE: ${{ inputs.image }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          echo "$PRIVATE_KEY" > key.pem
          chmod 400 key.pem

          echo "üåê SSH to $EC2_USER@$EC2_HOST"

          ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USERNAME@$EC2_HOST << EOF

            cd PolybotService

            echo "IMG_NAME=$IMAGE" > .env
            echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> .env
            echo "TELEGRAM_APP_URL=https://proxydeema.fursa.click" >> .env

            docker compose -f docker-compose.dev.yaml down || true
            docker compose -f docker-compose.dev.yaml pull
            docker compose -f docker-compose.dev.yaml up -d --build
          EOF
