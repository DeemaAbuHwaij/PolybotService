#!/bin/bash
set -e

PROJECT_DIR="$HOME/PolybotService"
SERVICE_FILE="polybot-dev.service"
VENV_PATH="$PROJECT_DIR/venv"
ENV_FILE="$PROJECT_DIR/.env"

# Clone repo if not exists
if [ ! -d "$PROJECT_DIR" ]; then
  echo "ðŸ“ Cloning repository..."
  git clone -b dev https://github.com/DeemaAbuHwaij/PolybotService.git "$PROJECT_DIR"
fi

# Go to project
cd "$PROJECT_DIR"
git pull origin dev

# Install venv if needed
if ! command -v python3 > /dev/null; then
  sudo apt update
  sudo apt install -y python3 python3-venv
fi

# Create venv if needed
if [ ! -d "$VENV_PATH" ]; then
  python3 -m venv "$VENV_PATH"
fi

source "$VENV_PATH/bin/activate"
pip install --upgrade pip
pip install -r "$PROJECT_DIR/polybot/requirements.txt"

# Copy service file
sudo cp "$PROJECT_DIR/$SERVICE_FILE" /etc/systemd/system/

# Enable and restart service
sudo systemctl daemon-reload
sudo systemctl enable polybot-dev.service
sudo systemctl restart polybot-dev.service
