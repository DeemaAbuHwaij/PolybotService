#!/bin/bash
set -e




PROJECT_DIR="$(pwd)"
SERVICE_FILE="polybot.service"
VENV_PATH="$PROJECT_DIR/venv"
ENV_FILE="$PROJECT_DIR/.env"

# Clone the repo if it doesn't exist
if [ ! -d "$PROJECT_DIR" ]; then
  echo "üì• Cloning repo..."
  git clone -b dev "$REPO_URL" "$PROJECT_DIR"
fi

# Go into the project folder and update it
cd "$PROJECT_DIR"
git pull origin dev

# Install Python and venv if needed
sudo apt update
sudo apt install -y python3 python3-venv python3-pip

# Set up virtual environment
if [ ! -d "$VENV_PATH" ]; then
  echo "üîß Creating virtualenv..."
  python3 -m venv "$VENV_PATH"
fi

source "$VENV_PATH/bin/activate"

# Install Python dependencies
echo "üì¶ Installing requirements..."
pip install --upgrade pip
pip install -r "$REQUIREMENTS"

# Copy the service file
echo "‚öôÔ∏è Setting up systemd service..."
sudo cp "$PROJECT_DIR/$SERVICE_FILE" /etc/systemd/system/

# Enable and start service
sudo systemctl daemon-reload
sudo systemctl enable polybot-dev.service
sudo systemctl restart polybot-dev.service

# Check status
if systemctl is-active --quiet polybot-dev.service; then
  echo "‚úÖ polybot-dev.service is running!"
else
  echo "‚ùå polybot-dev.service failed to start."
  sudo systemctl status polybot-dev.service
  exit 1
fi
